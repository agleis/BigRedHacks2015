<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
	<title>Flushr</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
	<link href="index.css" rel="stylesheet" type="text/css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js"></script>
	<script type="text/javascript" src="http://www.parsecdn.com/js/parse-latest.js"></script>
	<script>
		function initialize(){
			var mapCanvas = document.getElementById('map');
			var mapOptions = {
				center: new google.maps.LatLng(42.4476, -76.4827),
				zoom: 15,
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				mapTypeControl: false
			}
			var map = new google.maps.Map(mapCanvas, mapOptions);
			//var dict = {};
			Parse.initialize("GsttxbbcF21KkzLiXBBmGk3s1sHnScQx3sLRp7nP", "FJnL6Ip6hsuebnCPPpSglUxT3qAFKvOHQTBW5YQ1");
			var Building = Parse.Object.extend("Building");
			var query = new Parse.Query(Building);
			query.exists("Name");
			query.find({
				success: function(buildings) {
					localStorage.buildings = JSON.stringify(buildings);
					bb = JSON.parse(localStorage.buildings);
					console.log(bb);
					for(i=0; i < bb.length; i++){
						var lat = bb[i].Coordinates.latitude;
						var longi = bb[i].Coordinates.longitude;
						var name = bb[i].Name;
						createMarker(new google.maps.LatLng(lat, longi), name, map);
					}
				}	
			});
			var Bathroom = Parse.Object.extend("Bathroom");
			var query2 = new Parse.Query(Bathroom);
			query2.exists("Name");
			query2.find({
				success: function(bathrooms) {
					localStorage.bathrooms = JSON.stringify(bathrooms);
				}
			});
			}
		function createMarker(pos, t, m) {
			var image='blue-dot.png'
			var marker = new google.maps.Marker({
				position: pos,
				map: m,
				title: t,
				icon: image
			});
			google.maps.event.addListener(marker, 'click', function() {
				var building_of_pin = null;
				var building_array = JSON.parse(localStorage.buildings);
				console.log(building_array);
				for(i = 0; i < building_array.length; i++) {
					var name = building_array[i].Name;
					if(name == t) {
						building_of_pin = building_array[i];
						break;
					}
					else {
						building_of_pin = building_array[0];
					}
				}
				var bathroom_array = JSON.parse(localStorage.bathrooms);
				var baths_of_building = [];
				for(i = 0; i < bathroom_array.length; i++) {
					console.log(bathroom_array[i]);
					if(bathroom_array[i].Building == building_of_pin.Name) {
						baths_of_building.push(bathroom_array[i]);
					}
				}
				
				// Display in left sidebar
				html = "";
				html += '<div class="building"><p class="buildingname">'+building_of_pin.Name+'</p></div>';
				for(i = 0; i < baths_of_building.length; i++) {
					html += '<div class="bathroom"><p class="bathroom">'+baths_of_building[i].Name+'</p></div>';
				}
				document.getElementById("left_sidebar").innerHTML = html;
			});
			return marker;
		}
		google.maps.event.addDomListener(window, 'load', initialize);
		
		var holdUp = function(building) {
		  var promise = new Parse.Promise();
		  //loadBathrooms(building);
		  //promise.resolve();
		  var array = building[0].BathroomArray;
		  getBrooms(array).then(function() {
				localStorage.building = JSON.stringify(building);
		  });
		  promise.resolve();
		  return promise;
		};

		var getBrooms = function(array) {
			var promise = new Parse.Promise();
			var Bathroom = Parse.Object.extend("Bathroom");
			var query = new Parse.Query(Bathroom);
			for(i = 0; i < array.length; i++) {
				query.get(array[i], {
					success: function(bathroom) {
						var bath = JSON.parse(JSON.stringify(bathroom));
						array.push(bath);
						console.log(JSON.stringify(bath));
						localStorage.brooms = JSON.stringify(array);
					}
				});
			}
			promise.resolve();
			return promise;
		}
		
		// Increases the left sidebar
		function increaseLeft() {
			var str = i.toString().concat("px");
			document.getElementById("left_sidebar").style.width = str;
		}
	</script>
  </head>
  
  <body>
	<div id="header">
		<button type="button" onclick="bathroomGetter()" id="menu"><img src="menu.png" /></button>
		<img src="logo.png" id="logo" />
	</div>
	<div id="main">
		<div id="map">
		
		</div>
		<div id="left_sidebar">
			
		</div>
	</div>
  </body>
</html>